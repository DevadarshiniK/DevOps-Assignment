name: Deploy to AWS Dev

on:
  push:
    branches:
      - develop
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'infrastructure/docker/**'
      - '.github/workflows/aws-deploy.yml'
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPOSITORY: ${{ secrets.AWS_ECR_REPOSITORY }}
  TARGET_ENV: dev
  ECS_TASK_DEFINITION: devops-assignment-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
          role-session-name: github-actions-${{ github.sha }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Debug ECR Repository
        run: |
          echo "ECR_REPOSITORY: $ECR_REPOSITORY"
          echo "ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}"
          echo "AWS_ACCOUNT_ID: $AWS_ACCOUNT_ID"

      # ============ BACKEND DEPLOYMENT ============
      - name: Build and push backend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          docker build \
            -f infrastructure/docker/Dockerfile.backend \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      # ECS Task Definition versioning
      - name: Get current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --region ${{ env.AWS_REGION }} \
            --query taskDefinition > task-def.json

      - name: Filter task definition for registration
        run: |
          jq '{ 
            family: .family,
            taskRoleArn: .taskRoleArn,
            executionRoleArn: .executionRoleArn,
            networkMode: .networkMode,
            containerDefinitions: .containerDefinitions,
            requiresCompatibilities: .requiresCompatibilities,
            cpu: .cpu,
            memory: .memory,
            placementConstraints: .placementConstraints,
            volumes: .volumes
          }' task-def.json > task-def-filtered.json

      - name: Update image in task definition
        run: |
          jq ".containerDefinitions[0].image = \"${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ github.sha }}\"" task-def-filtered.json > task-def-updated.json
          cat task-def-updated.json

      - name: Register new task definition
        id: register-task-def
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-def-updated.json \
            --region ${{ env.AWS_REGION }} \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "task-def-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "Registered new task definition: $TASK_DEF_ARN"

      - name: Update ECS service
        env:
          CLUSTER: ${{ secrets.AWS_ECS_CLUSTER_NAME }}
          SERVICE: ${{ secrets.AWS_ECS_SERVICE_NAME }}
        run: |
          echo "Updating ECS service: $SERVICE with new task definition"
          aws ecs update-service \
            --cluster $CLUSTER \
            --service $SERVICE \
            --task-definition ${{ steps.register-task-def.outputs.task-def-arn }} \
            --region ${{ env.AWS_REGION }}

      - name: Wait for ECS service to stabilize
        run: |
          aws ecs wait services-stable \
            --cluster ${{ secrets.AWS_ECS_CLUSTER_NAME }} \
            --services ${{ secrets.AWS_ECS_SERVICE_NAME }} \
            --region ${{ env.AWS_REGION }}

      # ============ FRONTEND DEPLOYMENT ============
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      - name: Build frontend
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: http://${{ secrets.AWS_ALB_DNS_NAME }}
        run: npm run build

      - name: Upload frontend to S3
        run: |
          aws s3 sync ./frontend/out s3://${{ secrets.AWS_S3_BUCKET_NAME }}/ --delete

      - name: Invalidate CloudFront cache
        env:
          DISTRIBUTION_ID: ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          if [ -n "$DISTRIBUTION_ID" ]; then
            echo "Invalidating CloudFront distribution: $DISTRIBUTION_ID"
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
          fi

      # ============ HEALTH CHECK ============
      - name: Health check
        env:
          ALB_DNS: ${{ secrets.AWS_ALB_DNS_NAME }}
        run: |
          echo "Health checking: http://$ALB_DNS/api/health"
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://$ALB_DNS/api/health" || echo "000")
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "✅ Backend is healthy"
              exit 0
            fi
            echo "Attempt $i/30: Backend returned HTTP $HTTP_CODE, waiting..."
            sleep 10
          done
          echo "❌ Backend health check failed"
          exit 1

      # ============ NOTIFICATIONS ============
      - name: Deployment Summary
        if: always()
        run: |
          echo "## ✅ Dev Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | URL/Name |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Backend API** | http://${{ secrets.AWS_ALB_DNS_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Frontend CDN** | https://${{ secrets.AWS_CLOUDFRONT_DOMAIN }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **S3 Bucket** | ${{ secrets.AWS_S3_BUCKET_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Task Definition** | ${{ steps.register-task-def.outputs.task-def-arn }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify success
        if: success()
        run: |
          echo "✅ Dev deployment successful!"
          echo "Backend URL: http://${{ secrets.AWS_ALB_DNS_NAME }}"
          echo "Frontend URL: https://${{ secrets.AWS_CLOUDFRONT_DOMAIN }}"
          echo "Task Definition: ${{ steps.register-task-def.outputs.task-def-arn }}"

      - name: Notify failure
        if: failure()
        run: |
          echo "❌ Dev deployment failed"
          exit 1